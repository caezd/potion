var potion=function(){"use strict";function e(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return function(t,n,r={}){const o={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",...r},i={};let s={},c=!1;const l=new RegExp(`${e(o.start)}\\s*(!?)\\s*(${o.path})\\s*${e(o.end)}`,"gi");function a(e,t,...n){return(i[e]||[]).reduce(((e,[t])=>{const r=t(e,...n);return void 0!==r?r:""}),t)}function u(e,t){if("string"==typeof e){if(void 0===t)return s[e]||"";!1===t?delete s[e]:s[e]=t}else"object"==typeof e&&null!==e?Object.keys(e).forEach((t=>{u(t,e[t])})):"boolean"!=typeof e||e||(s={});return s}function f(e,t){[...e.attributes].filter((e=>e.name.startsWith("@"))).forEach((n=>{const r=n.name.slice(1).split("."),o=r[0],i=r.slice(1),s=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!s)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const c=s[1],l=s[2]||"",a=l?l.split(",").map((e=>function(e,t){return"true"===e||"false"!==e&&(isNaN(e)?e.match(/^["'](.*)["']$/)?e.slice(1,-1):t[e]||e:Number(e))}(e.trim(),t))):[];if("function"==typeof t[c]){e.removeEventListener(o,e._boundEvents?.[o]);const n=e=>{if(!i.includes("self")||e.target===e.currentTarget){if(i.includes("prevent")&&e.preventDefault(),i.includes("stop")&&e.stopPropagation(),i.includes("stopImmediate")&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),e instanceof MouseEvent){if(i.includes("left")&&0!==e.button)return;if(i.includes("right")&&2!==e.button)return;if(i.includes("middle")&&1!==e.button)return}if(e instanceof KeyboardEvent){if(i.includes("ctrl")&&!e.ctrlKey)return;if(i.includes("shift")&&!e.shiftKey)return;if(i.includes("alt")&&!e.altKey)return;if(i.includes("meta")&&!e.metaKey)return;if(i.includes("enter")&&"Enter"!==e.key)return;if(i.includes("tab")&&"Tab"!==e.key)return;if(i.includes("delete")&&"Delete"!==e.key&&"Backspace"!==e.key)return;if(i.includes("esc")&&"Escape"!==e.key)return;if(i.includes("space")&&" "!==e.key&&"Spacebar"!==e.key&&"Space"!==e.key)return;if(i.includes("up")&&"ArrowUp"!==e.key)return;if(i.includes("down")&&"ArrowDown"!==e.key)return;if(i.includes("left")&&"ArrowLeft"!==e.key)return;if(i.includes("right")&&"ArrowRight"!==e.key)return;if(i.includes("exact")){const t=i.includes("ctrl"),n=i.includes("shift"),r=i.includes("alt"),o=i.includes("meta");if(e.ctrlKey!==t||e.shiftKey!==n||e.altKey!==r||e.metaKey!==o)return}}t[c](e,...a)}};e._boundEvents={...e._boundEvents,[o]:n};const r={};i.includes("capture")&&(r.capture=!0),i.includes("once")&&(r.once=!0),i.includes("passive")&&(r.passive=!0),e.addEventListener(o,n,r)}else console.warn(`Potion: function '${c}' not found in data.`);e.removeAttribute(n.name)}))}function d(e,t){if(c||(c=!0,a("init")),!(e=a("templateBefore",e)).includes(o.start)){const t=u(e);t&&(e=t)}return(e=a("template",e))&&void 0!==t&&(e=function(e,t){let n;for(;null!==(n=l.exec(e));){const r=n[2];let i=a("token",r,t,e);const s=n.index,c=l.lastIndex,u=e.slice(0,s);let f=e.slice(c);if("function"==typeof i&&(i=i.call(t,t)),"boolean"!=typeof i&&"object"!=typeof i)e=u+i+f;else{let t="";const s=`${o.start}/${r}${o.end}`,c=f.indexOf(s);if(!(c>=0))throw new Error(`Potion: '${r}' not closed`);{const o=f.slice(0,c);if(f=f.slice(c+s.length),"boolean"==typeof i)t=i^"!"!==n[1]?"":o;else{for(const e in i)if(i.hasOwnProperty(e)){l.lastIndex=0;const n=a("loopData",{_key:e,_value:i[e],...i[e]},o,r);t+=a("loop",d(o,n),r,n)}t=a("loopEnd",t,r,i)}e=u+t+f}}l.lastIndex=0}return e}(e,t)),a("templateAfter",e)}function p(e,t,n,r={}){const o=d(t,n),i=document.createElement("div");return i.innerHTML=o,f(i,n),i.querySelectorAll("*").forEach((e=>f(e,n))),e.parentNode.replaceChild(i,e),i}if(function(e,t,n=0){if("function"!=typeof t)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");i[e]=i[e]||[],i[e].push([t,n]),i[e].sort(((e,t)=>e[1]-t[1]))}("token",((e,t,n)=>{const r=e.split(".");let o=t;for(let e=0;e<r.length;e++){if(!Object.prototype.hasOwnProperty.call(o,r[e]))throw new Error(`Potion: '${r[e]}' not found${e?` in ${n}`:""}`);if(o=o[r[e]],e===r.length-1)return o}})),window&&window.document){const m=o.type||"template/potion",y=o.attr||"data-name",h=document.querySelectorAll(`template[type='${m}']`);function b(e,t){const n=document.querySelector(`template[data-name='${e}']`);if(!n)throw new Error(`Potion: template with name '${e}' not found`);const r=p(n,e,t);function o(e,t){if(e.nodeType===t.nodeType&&e.nodeName===t.nodeName)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){Array.from(t.attributes).forEach((t=>{t.name.startsWith("@")||e.getAttribute(t.name)!==t.value&&e.setAttribute(t.name,t.value)})),Array.from(e.attributes).forEach((n=>{n.name.startsWith("@")||t.hasAttribute(n.name)||e.removeAttribute(n.name)}));const n=e.childNodes,r=t.childNodes,i=Math.max(n.length,r.length);for(let t=0;t<i;t++)t>=n.length?e.appendChild(r[t].cloneNode(!0)):t>=r.length?e.removeChild(n[t]):o(n[t],r[t])}}else e.textContent!==t.textContent&&(e.textContent=t.textContent);else e.parentNode.replaceChild(t.cloneNode(!0),e)}function i(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstChild;o(r,t)}return function n(o){return"object"!=typeof o||null===o?o:new Proxy(o,{get:(e,t)=>n(Reflect.get(e,t)),set(n,o,s){const c=n[o],l=Reflect.set(n,o,s);if(c!==s){i(d(e,t)),f(r,t),r.querySelectorAll("*").forEach((e=>f(e,t)))}return l}})}(t)}d.renderFromDOM=function(){const e={};return h.forEach(((t,n)=>{const r=t.getAttribute(y)||`potion-${n}`;e[r]=t.innerHTML})),u(e),e},d.renderFromDOM(),d.render=function(e,t,n={}){const r=document.querySelector(`template[data-name='${e}']`);if(!r)throw new Error(`Potion: template with name '${e}' not found`);return p(r,e,t,n)},d.sync=b}return d}()}();
