var potion=function(){"use strict";function e(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const t={};function n(e,n,o=0){if("string"!=typeof e||"function"!=typeof n)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");t[e]=t[e]||[],t[e].push([n,o]),t[e].sort(((e,t)=>e[1]-t[1]))}function o(e,n,...o){return(t[e]||[]).reduce(((e,[t])=>{const n=t(e,...o);return void 0!==n?n:""}),n)}n("token",((e,t,n)=>{const o=e.split(".");let r=t;for(let e=0;e<o.length;e++){if(!Object.prototype.hasOwnProperty.call(r,o[e]))return"";r=r[o[e]]}return r}));let r=0;const a=new Map,i=new Map;function s(t,n){if(i.has(t))return i.get(t);const o=function(t,n){const o=new RegExp(`${e(n.start)}\\s*([!\\/]?)\\s*(${n.path})\\s*${e(n.end)}`,"gi");let r,a=[],i=0;for(;null!==(r=o.exec(t));)r.index>i&&a.push({type:"static",value:t.slice(i,r.index)}),a.push({type:"token",flag:r[1],value:r[2]}),i=o.lastIndex;return i<t.length&&a.push({type:"static",value:t.slice(i)}),a}(t,n);return i.set(t,o),o}function c(e,t,n){const i=s(e,n);let l="",u=0;for(;u<i.length;){const s=i[u];if("static"===s.type)l+=s.value,u++;else if("token"===s.type){if("/"===s.flag){u++;continue}let f,p=[],d=u+1,m=!1;for(;d<i.length;){const e=i[d];if("token"===e.type&&"/"===e.flag&&e.value===s.value){m=!0;break}p.push(e),d++}try{f=o("token",s.value,t,e)}catch(e){console.warn(e.message),f=""}if(m){const e=p.map((e=>"static"===e.type?e.value:`${n.start}${e.flag?e.flag:""}${e.value}${n.end}`)).join("");if("boolean"==typeof f)l+=f?c(e,t,n):"";else if("object"==typeof f){for(const t in f)if(f.hasOwnProperty(t)){const o=Object.assign({},f[t],{_key:t,_value:f[t]});let i=c(e,o,n).trim();const s="potion_"+r++;a.set(s,o),i=i.replace(/^\s*<([a-zA-Z0-9-]+)/,`<$1 data-potion-key="${s}"`),l+=i}}else l+=f;u=d+1}else l+=f,u++}}return l}const l=a;function u(e,t){[...e.attributes].filter((e=>e.name.startsWith("@"))).forEach((n=>{const o=n.name.slice(1).split("."),r=o[0],a=o.slice(1),i=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!i)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const s=i[1],c=i[2]||"",u=function(e,t){let n=e;for(;n&&n!==document.body;){const e=n.getAttribute("data-potion-key");if(e){const t=l.get(e);if(void 0!==t)return t}n=n.parentElement}return t}(e,t),f=c?c.split(",").map((e=>function(e,t){if("true"===e)return!0;if("false"===e)return!1;if(!isNaN(e))return Number(e);const n=e.match(/^["'](.*)["']$/);return n?n[1]:t[e]||e}(e.trim(),u))):[],p="function"==typeof u[s]?u[s]:"function"==typeof t[s]?t[s]:null;if("function"==typeof p){e.removeEventListener(r,e._boundEvents?.[r]);const t=e=>{a.includes("self")&&e.target!==e.currentTarget||(a.includes("prevent")&&e.preventDefault(),a.includes("stop")&&e.stopPropagation(),a.includes("stopImmediate")&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),p.call(u,e,...f))};e._boundEvents={...e._boundEvents,[r]:t};const n={};a.includes("capture")&&(n.capture=!0),a.includes("once")&&(n.once=!0),a.includes("passive")&&(n.passive=!0),e.addEventListener(r,t,n)}else console.warn(`Potion: function '${s}' not found in local context or data.`);e.removeAttribute(n.name)}))}function f(e,t){if(e.nodeType===t.nodeType&&e.nodeName===t.nodeName)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){Array.from(t.attributes).forEach((t=>{t.name.startsWith("@")||e.getAttribute(t.name)!==t.value&&e.setAttribute(t.name,t.value)})),Array.from(e.attributes).forEach((n=>{n.name.startsWith("@")||t.hasAttribute(n.name)||e.removeAttribute(n.name)}));const n=e.childNodes,o=t.childNodes,r=Math.max(n.length,o.length);for(let t=0;t<r;t++)t>=n.length?e.appendChild(o[t].cloneNode(!0)):t>=o.length?e.removeChild(n[t]):f(n[t],o[t])}}else e.textContent!==t.textContent&&(e.textContent=t.textContent);else e.parentNode.replaceChild(t.cloneNode(!0),e)}function p(e,t){f(e,(new DOMParser).parseFromString(`<div>${t}</div>`,"text/html").body.firstChild)}const d=new WeakMap;function m(e,t,n=1/0,o=0){if("object"!=typeof e||null===e)return e;if(o>=n)return e;if(d.has(e))return d.get(e);const r=new Proxy(e,{get:(e,r)=>m(Reflect.get(e,r),t,n,o+1),set(e,n,o){const r=e[n],a=Reflect.set(e,n,o);return r!==o&&t(),a}});return d.set(e,r),r}let h={},y=!1;let v={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",type:"template/potion",attr:"data-name"};function g(e,t){return y||(y=!0,o("init",e,t)),(e=o("templateBefore",e,t)).includes(v.start)||(e=h[e]||e),(e=o("template",e,t))&&void 0!==t&&(e=c(e,t,v)),o("templateAfter",e,t)}function b(e,t,n){const o=g(e.innerHTML,n),r=document.createElement("div");return r.innerHTML=o,u(r,n),r.querySelectorAll("*").forEach((e=>u(e,n))),e.parentNode.replaceChild(r,e),r}function E(e,t){return g(e,t)}return E.sync=function(e,t){const n=document.querySelector(`template[data-name='${e}']`);if(!n)throw new Error(`Potion: template with name '${e}' not found`);n.innerHTML;const o=b(n,0,t);return m(t,(()=>{const e=g(n.innerHTML,t);p(o,e),u(o,t),o.querySelectorAll("*").forEach((e=>u(e,t)))}))},E.render=function(e,t){const n=document.querySelector(`template[data-name='${e}']`);if(!n)throw new Error(`Potion: template with name '${e}' not found`);return b(n,0,t)},E.renderFromDOM=function(){const e=v.type,t=v.attr,n=document.querySelectorAll(`template[type='${e}']`),o={};return n.forEach(((e,n)=>{const r=e.getAttribute(t)||`potion-${n}`;o[r]=e.innerHTML})),h=o,o},E.renderString=function(e,t){return g(e,t)},E.addFilter=n,E.applyFilter=o,E}();
