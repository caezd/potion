const e={};function t(t,n,o=0){if("string"!=typeof t||"function"!=typeof n)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");e[t]=e[t]||[],e[t].push([n,o]),e[t].sort(((e,t)=>e[1]-t[1]))}function n(t,n,...o){return(e[t]||[]).reduce(((e,[t])=>{const n=t(e,...o);return void 0!==n?n:""}),n)}function o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}t("token",((e,t,n)=>{const o=e.split(".");let r=t;for(let e=0;e<o.length;e++){if(!Object.prototype.hasOwnProperty.call(r,o[e]))return"";r=r[o[e]]}return r}));let r=0;const a=new Map,i=new Map;function s(e,t){if(i.has(e))return i.get(e);const n=function(e,t){const n=new RegExp(`${o(t.start)}\\s*([!\\/]?)\\s*(${t.path})\\s*${o(t.end)}`,"gi");let r,a=[],i=0;for(;null!==(r=n.exec(e));)r.index>i&&a.push({type:"static",value:e.slice(i,r.index)}),a.push({type:"token",flag:r[1],value:r[2]}),i=n.lastIndex;return i<e.length&&a.push({type:"static",value:e.slice(i)}),a}(e,t);return i.set(e,n),n}function l(e,t,o){const i=s(e,o);let c="",u=0;for(;u<i.length;){const s=i[u];if("static"===s.type)c+=s.value,u++;else if("token"===s.type){if("/"===s.flag){u++;continue}let f,p=[],d=u+1,m=!1;for(;d<i.length;){const e=i[d];if("token"===e.type&&"/"===e.flag&&e.value===s.value){m=!0;break}p.push(e),d++}try{f=n("token",s.value,t,e)}catch(e){console.warn(e.message),f=""}if(m){const e=p.map((e=>"static"===e.type?e.value:`${o.start}${e.flag?e.flag:""}${e.value}${o.end}`)).join("");if("boolean"==typeof f)c+=f?l(e,t,o):"";else if("object"==typeof f){for(const t in f)if(f.hasOwnProperty(t)){const n=Object.assign({},f[t],{_key:t,_value:f[t]});let i=l(e,n,o).trim();const s="potion_"+r++;a.set(s,n),i=i.replace(/^\s*<([a-zA-Z0-9-]+)/,`<$1 data-potion-key="${s}"`),c+=i}}else c+=f;u=d+1}else c+=f,u++}}return c}const c=a;function u(e,t){[...e.attributes].filter((e=>e.name.startsWith("@"))).forEach((n=>{const o=n.name.slice(1).split("."),r=o[0],a=o.slice(1),i=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!i)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const s=i[1],l=i[2]||"",u=function(e,t){let n=e;for(;n&&n!==document.body;){const e=n.getAttribute("data-potion-key");if(e){const t=c.get(e);if(void 0!==t)return t}n=n.parentElement}return t}(e,t),f=l?l.split(",").map((e=>function(e,t){if("true"===e)return!0;if("false"===e)return!1;if(!isNaN(e))return Number(e);const n=e.match(/^["'](.*)["']$/);return n?n[1]:t[e]||e}(e.trim(),u))):[],p="function"==typeof u[s]?u[s]:"function"==typeof t[s]?t[s]:null;if("function"==typeof p){e.removeEventListener(r,e._boundEvents?.[r]);const t=e=>{a.includes("self")&&e.target!==e.currentTarget||(a.includes("prevent")&&e.preventDefault(),a.includes("stop")&&e.stopPropagation(),a.includes("stopImmediate")&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),p.call(u,e,...f))};e._boundEvents={...e._boundEvents,[r]:t};const n={};a.includes("capture")&&(n.capture=!0),a.includes("once")&&(n.once=!0),a.includes("passive")&&(n.passive=!0),e.addEventListener(r,t,n)}else console.warn(`Potion: function '${s}' not found in local context or data.`);e.removeAttribute(n.name)}))}function f(e,t){if(e.nodeType===t.nodeType&&e.nodeName===t.nodeName)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){Array.from(t.attributes).forEach((t=>{t.name.startsWith("@")||e.getAttribute(t.name)!==t.value&&e.setAttribute(t.name,t.value)})),Array.from(e.attributes).forEach((n=>{n.name.startsWith("@")||t.hasAttribute(n.name)||e.removeAttribute(n.name)}));const n=e.childNodes,o=t.childNodes,r=Math.max(n.length,o.length);for(let t=0;t<r;t++)t>=n.length?e.appendChild(o[t].cloneNode(!0)):t>=o.length?e.removeChild(n[t]):f(n[t],o[t])}}else e.textContent!==t.textContent&&(e.textContent=t.textContent);else e.parentNode.replaceChild(t.cloneNode(!0),e)}function p(e,t){f(e,(new DOMParser).parseFromString(`<div>${t}</div>`,"text/html").body.firstChild)}const d=new WeakMap;function m(e,t,n=1/0,o=0){if("object"!=typeof e||null===e)return e;if(o>=n)return e;if(d.has(e))return d.get(e);const r=new Proxy(e,{get:(e,r)=>m(Reflect.get(e,r),t,n,o+1),set(e,n,o){const r=e[n],a=Reflect.set(e,n,o);return r!==o&&t(),a}});return d.set(e,r),r}let h={},y=!1;let g={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",type:"template/potion",attr:"data-name",tag:"div",class:""};function v(e,t){return y||(y=!0,n("init",e,t)),(e=n("templateBefore",e,t)).includes(g.start)||(e=h[e]||e),(e=n("template",e,t))&&void 0!==t&&(e=l(e,t,g)),n("templateAfter",e,t)}function b(e,t,n,o){o={...g,...o};const r=v(e.innerHTML,n);let a;var i;return a=!o.tag||(i=o.tag,document.createElement(i)instanceof HTMLUnknownElement)?document.createElement(g.tag):document.createElement(o.tag),a.innerHTML=r,[...e.attributes].forEach((e=>{"type"!==e.name&&a.setAttribute(e.name,e.value)})),o.class&&a.classList.add(o.class),u(a,n),a.querySelectorAll("*").forEach((e=>u(e,n))),e.parentNode.replaceChild(a,e),a}function E(e,t){return v(e,t)}E.sync=function(e,t,n){const o=document.querySelector(`template[data-name='${e}']`);if(!o)throw new Error(`Potion: template with name '${e}' not found`);const r=b(o,0,t,n);return m(t,(()=>{const e=v(o.innerHTML,t);p(r,e),u(r,t),r.querySelectorAll("*").forEach((e=>u(e,t)))}))},E.render=function(e,t,n){const o=document.querySelector(`template[data-name='${e}']`);if(!o)throw new Error(`Potion: template with name '${e}' not found`);return b(o,0,t,n)},E.addFilter=t,E.applyFilter=n;export{E as default};
