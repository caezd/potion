const e={};function t(t,n,o=0){if("string"!=typeof t||"function"!=typeof n)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");e[t]=e[t]||[],e[t].push([n,o]),e[t].sort(((e,t)=>e[1]-t[1]))}function n(t,n,...o){return(e[t]||[]).reduce(((e,[t])=>{const n=t(e,...o);return void 0!==n?n:""}),n)}function o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}t("token",((e,t,n)=>{const o=e.split(".");let r=t;for(let e=0;e<o.length;e++){if(!Object.prototype.hasOwnProperty.call(r,o[e]))return"";r=r[o[e]]}return r}));const r=_userdata,a={user:{name:r.username,logged_in:r.session_logged_in,level:r.user_level,id:r.user_id,posts:r.user_posts,avatar:r.avatar,avatar_link:r.avatar_link,group_color:r.groupcolor}},s=e=>Object.assign({$store:a},e);let i=0;const l=new Map,c=new Map;function u(e,t){if(c.has(e))return c.get(e);const n=function(e,t){const n=new RegExp(`${o(t.start)}\\s*([!\\/]?)\\s*(${t.path})\\s*${o(t.end)}`,"gi");let r,a=[],s=0;for(;null!==(r=n.exec(e));)r.index>s&&a.push({type:"static",value:e.slice(s,r.index)}),a.push({type:"token",flag:r[1],value:r[2]}),s=n.lastIndex;return s<e.length&&a.push({type:"static",value:e.slice(s)}),a}(e,t);return c.set(e,n),n}function f(e,t,o){const r=u(e,o);let a="",s=0;for(;s<r.length;){const c=r[s];if("static"===c.type)a+=c.value,s++;else if("token"===c.type){if("/"===c.flag){s++;continue}let u,p=[],d=s+1,m=!1;for(;d<r.length;){const e=r[d];if("token"===e.type&&"/"===e.flag&&e.value===c.value){m=!0;break}p.push(e),d++}try{u=n("token",c.value,t,e)}catch(e){console.warn(e.message),u=""}if(m){const e=p.map((e=>"static"===e.type?e.value:`${o.start}${e.flag?e.flag:""}${e.value}${o.end}`)).join("");if("boolean"==typeof u)a+=u?f(e,t,o):"";else if("object"==typeof u){for(const t in u)if(u.hasOwnProperty(t)){const n=Object.assign({},u[t],{_key:t,_value:u[t]});let r=f(e,n,o).trim();const s="potion_"+i++;l.set(s,n),r=r.replace(/^\s*<([a-zA-Z0-9-]+)/,`<$1 data-potion-key="${s}"`),a+=r}}else a+=u;s=d+1}else a+=u,s++}}return a}const p=l;function d(e,t){[...e.attributes].filter((e=>e.name.startsWith("@"))).forEach((n=>{const o=n.name.slice(1).split("."),r=o[0],a=o.slice(1),s=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!s)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const i=s[1],l=s[2]||"",c=function(e,t){let n=e;for(;n&&n!==document.body;){const e=n.getAttribute("data-potion-key");if(e){const t=p.get(e);if(void 0!==t)return t}n=n.parentElement}return t}(e,t),u=l?l.split(",").map((e=>function(e,t){if("true"===e)return!0;if("false"===e)return!1;if(!isNaN(e))return Number(e);const n=e.match(/^["'](.*)["']$/);return n?n[1]:t[e]||e}(e.trim(),c))):[],f="function"==typeof c[i]?c[i]:"function"==typeof t[i]?t[i]:null;if("function"==typeof f){e.removeEventListener(r,e._boundEvents?.[r]);const t=e=>{a.includes("self")&&e.target!==e.currentTarget||(a.includes("prevent")&&e.preventDefault(),a.includes("stop")&&e.stopPropagation(),a.includes("stopImmediate")&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),f.call(c,e,...u))};e._boundEvents={...e._boundEvents,[r]:t};const n={};a.includes("capture")&&(n.capture=!0),a.includes("once")&&(n.once=!0),a.includes("passive")&&(n.passive=!0),e.addEventListener(r,t,n)}else console.warn(`Potion: function '${i}' not found in local context or data.`);e.removeAttribute(n.name)}))}function m(e,t){if(e.nodeType===t.nodeType&&e.nodeName===t.nodeName)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){Array.from(t.attributes).forEach((t=>{t.name.startsWith("@")||e.getAttribute(t.name)!==t.value&&e.setAttribute(t.name,t.value)})),Array.from(e.attributes).forEach((n=>{n.name.startsWith("@")||t.hasAttribute(n.name)||e.removeAttribute(n.name)}));const n=e.childNodes,o=t.childNodes,r=Math.max(n.length,o.length);for(let t=0;t<r;t++)t>=n.length?e.appendChild(o[t].cloneNode(!0)):t>=o.length?e.removeChild(n[t]):m(n[t],o[t])}}else e.textContent!==t.textContent&&(e.textContent=t.textContent);else e.parentNode.replaceChild(t.cloneNode(!0),e)}function g(e,t){const n=e.tagName.toLowerCase(),o=(new DOMParser).parseFromString(`<${n}>${t}</${n}>`,"text/html").body.firstChild;[...e.attributes].forEach((e=>{o.setAttribute(e.name,e.value)})),m(e,o)}const h=new WeakMap;function y(e,t,n=1/0,o=0){if("object"!=typeof e||null===e)return e;if(o>=n)return e;if(h.has(e))return h.get(e);const r=new Proxy(e,{get:(e,r)=>y(Reflect.get(e,r),t,n,o+1),set(e,n,o){const r=e[n],a=Reflect.set(e,n,o);return r!==o&&t(),a}});return h.set(e,r),r}let v={},b=!1;let E={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",type:"template/potion",attr:"data-name",tag:"div",class:""};function w(e,t){return t=s(t),b||(b=!0,n("init",e,t)),(e=n("templateBefore",e,t)).includes(E.start)||(e=v[e]||e),(e=n("template",e,t))&&void 0!==t&&(e=f(e,t,E)),n("templateAfter",e,t)}function $(e,t,n){n={...E,...n},t=s(t);const o=w(e.innerHTML,t);let r;var a;return r=!n.tag||(a=n.tag,document.createElement(a)instanceof HTMLUnknownElement)?document.createElement(E.tag):document.createElement(n.tag),r.innerHTML=o,[...e.attributes].forEach((e=>{"type"!==e.name&&r.setAttribute(e.name,e.value)})),n.class&&r.classList.add(...n.class.split(" ")),d(r,t),r.querySelectorAll("*").forEach((e=>d(e,t))),e.parentNode.replaceChild(r,e),r}function _(e,t){return w(e,t)}"undefined"!=typeof window&&document.querySelectorAll(`template[type="${E.type}"]`).forEach((e=>{const t=e.getAttribute(E.attr);v[t]=e.innerHTML})),_.sync=function(e,t,n){const o=document.querySelector(`template[data-name='${e}']`);if(!o)throw new Error(`Potion: template with name '${e}' not found`);t=s(t);const r=$(o,t,n);return y(t,(()=>{const e=w(o.innerHTML,t);g(r,e),d(r,t),r.querySelectorAll("*").forEach((e=>d(e,t)))}))},_.render=function(e,t,n){const o=document.querySelector(`template[data-name='${e}']`);if(!o)throw new Error(`Potion: template with name '${e}' not found`);return $(o,t,n)},_.addFilter=t,_.applyFilter=n;export{_ as default};
