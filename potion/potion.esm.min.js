function e(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var t=function(t,n,o={}){const r=new Map;let i=0;const s={start:"[",end:"]",path:"[a-z0-9_$][\\.a-z0-9_]*",...o},c={};let l={},a=!1;const u=new RegExp(`${e(s.start)}\\s*(!?)\\s*(${s.path})\\s*${e(s.end)}`,"gi");function f(e,t,...n){return(c[e]||[]).reduce(((e,[t])=>{const o=t(e,...n);return void 0!==o?o:""}),t)}function d(e,t){if("string"==typeof e){if(void 0===t)return l[e]||"";!1===t?delete l[e]:l[e]=t}else"object"==typeof e&&null!==e?Object.keys(e).forEach((t=>{d(t,e[t])})):"boolean"!=typeof e||e||(l={});return l}function p(e,t){[...e.attributes].filter((e=>e.name.startsWith("@"))).forEach((n=>{const o=n.name.slice(1).split("."),i=o[0],s=o.slice(1),c=n.value.match(/^(\w+)(?:\((.*)\))?$/);if(!c)return void console.warn("Potion: impossible de parser l'expression de l'événement:",n.value);const l=c[1],a=c[2]||"",u=function(e,t){let n=e;for(;n&&n!==document.body;){const e=n.getAttribute("data-potion-key");if(e){const t=r.get(e);if(void 0!==t)return t}n=n.parentElement}return t}(e,t),f=a?a.split(",").map((e=>function(e,t){return"true"===e||"false"!==e&&(isNaN(e)?e.match(/^["'](.*)["']$/)?e.slice(1,-1):t[e]||e:Number(e))}(e.trim(),u))):[];if("function"==typeof t[l]){e.removeEventListener(i,e._boundEvents?.[i]);const n=e=>{if(!s.includes("self")||e.target===e.currentTarget){if(s.includes("prevent")&&e.preventDefault(),s.includes("stop")&&e.stopPropagation(),s.includes("stopImmediate")&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),e instanceof MouseEvent){if(s.includes("left")&&0!==e.button)return;if(s.includes("right")&&2!==e.button)return;if(s.includes("middle")&&1!==e.button)return}if(e instanceof KeyboardEvent){if(s.includes("ctrl")&&!e.ctrlKey)return;if(s.includes("shift")&&!e.shiftKey)return;if(s.includes("alt")&&!e.altKey)return;if(s.includes("meta")&&!e.metaKey)return;if(s.includes("enter")&&"Enter"!==e.key)return;if(s.includes("tab")&&"Tab"!==e.key)return;if(s.includes("delete")&&"Delete"!==e.key&&"Backspace"!==e.key)return;if(s.includes("esc")&&"Escape"!==e.key)return;if(s.includes("space")&&" "!==e.key&&"Spacebar"!==e.key&&"Space"!==e.key)return;if(s.includes("up")&&"ArrowUp"!==e.key)return;if(s.includes("down")&&"ArrowDown"!==e.key)return;if(s.includes("left")&&"ArrowLeft"!==e.key)return;if(s.includes("right")&&"ArrowRight"!==e.key)return;if(s.includes("exact")){const t=s.includes("ctrl"),n=s.includes("shift"),o=s.includes("alt"),r=s.includes("meta");if(e.ctrlKey!==t||e.shiftKey!==n||e.altKey!==o||e.metaKey!==r)return}}t[l](e,...f)}};e._boundEvents={...e._boundEvents,[i]:n};const o={};s.includes("capture")&&(o.capture=!0),s.includes("once")&&(o.once=!0),s.includes("passive")&&(o.passive=!0),e.addEventListener(i,n,o)}else console.warn(`Potion: function '${l}' not found in data.`);e.removeAttribute(n.name)}))}function m(e,t){if(a||(a=!0,f("init")),!(e=f("templateBefore",e)).includes(s.start)){const t=d(e);t&&(e=t)}return(e=f("template",e))&&void 0!==t&&(e=function(e,t){let n;for(;null!==(n=u.exec(e));){const o=n[2];let c=f("token",o,t,e);const l=n.index,a=u.lastIndex,d=e.slice(0,l);let p=e.slice(a);if("function"==typeof c&&(c=c.call(t,t)),"boolean"!=typeof c&&"object"!=typeof c)e=d+c+p;else{let t="";const l=`${s.start}/${o}${s.end}`,a=p.indexOf(l);if(!(a>=0))throw new Error(`Potion: '${o}' not closed`);{const s=p.slice(0,a);if(p=p.slice(a+l.length),"boolean"==typeof c)t=c^"!"!==n[1]?"":s;else{for(const e in c)if(c.hasOwnProperty(e)){u.lastIndex=0;const n=f("loopData",{_key:e,_value:c[e],...c[e]},s,o);let l=m(s,n);const a="potion_"+i++;r.set(a,n),l&&(l=l.replace(/<([a-zA-Z0-9-]+)/,`<$1 data-potion-key="${a}"`)),t+=f("loop",l,o,n)}t=f("loopEnd",t,o,c)}e=d+t+p}}u.lastIndex=0}return e}(e,t)),f("templateAfter",e)}function y(e,t,n,o={}){const r=m(e.innerHTML,n),i=document.createElement("div");return i.innerHTML=r,p(i,n),i.querySelectorAll("*").forEach((e=>p(e,n))),e.parentNode.replaceChild(i,e),i}if(function(e,t,n=0){if("function"!=typeof t)throw new TypeError("Invalid arguments: 'name' must be a string and 'fn' must be a function.");c[e]=c[e]||[],c[e].push([t,n]),c[e].sort(((e,t)=>e[1]-t[1]))}("token",((e,t,n)=>{const o=e.split(".");let r=t;for(let e=0;e<o.length;e++){if(!Object.prototype.hasOwnProperty.call(r,o[e]))throw new Error(`Potion: '${o[e]}' not found${e?` in ${n}`:""}`);if(r=r[o[e]],e===o.length-1)return r}})),window&&window.document){const h=s.type||"template/potion",b=s.attr||"data-name",v=document.querySelectorAll(`template[type='${h}']`);function w(e,t){const n=document.querySelector(`template[data-name='${e}']`);if(!n)throw new Error(`Potion: template with name '${e}' not found`);const o=y(n,0,t);function r(e,t){if(e.nodeType===t.nodeType&&e.nodeName===t.nodeName)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){Array.from(t.attributes).forEach((t=>{t.name.startsWith("@")||e.getAttribute(t.name)!==t.value&&e.setAttribute(t.name,t.value)})),Array.from(e.attributes).forEach((n=>{n.name.startsWith("@")||t.hasAttribute(n.name)||e.removeAttribute(n.name)}));const n=e.childNodes,o=t.childNodes,i=Math.max(n.length,o.length);for(let t=0;t<i;t++)t>=n.length?e.appendChild(o[t].cloneNode(!0)):t>=o.length?e.removeChild(n[t]):r(n[t],o[t])}}else e.textContent!==t.textContent&&(e.textContent=t.textContent);else e.parentNode.replaceChild(t.cloneNode(!0),e)}function i(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstChild;r(o,t)}return function n(r){return"object"!=typeof r||null===r?r:new Proxy(r,{get:(e,t)=>n(Reflect.get(e,t)),set(n,r,s){const c=n[r],l=Reflect.set(n,r,s);if(c!==s){i(m(e,t)),p(o,t),o.querySelectorAll("*").forEach((e=>p(e,t)))}return l}})}(t)}m.renderFromDOM=function(){const e={};return v.forEach(((t,n)=>{const o=t.getAttribute(b)||`potion-${n}`;e[o]=t.innerHTML})),d(e),e},m.renderFromDOM(),m.render=function(e,t,n={}){const o=document.querySelector(`template[data-name='${e}']`);if(!o)throw new Error(`Potion: template with name '${e}' not found`);return y(o,0,t,n)},m.sync=w}return m}();export{t as default};
